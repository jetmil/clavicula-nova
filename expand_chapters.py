#!/usr/bin/env python3
"""
Расширение коротких глав гримуара CLAVICULA NOVA
Автоматическое добавление содержательного эзотерического контента
"""

import json
import re

# Шаблоны расширения по типам глав
EXPANSION_TEMPLATES = {
    # Введения в традиции
    "введение": """

Каждая духовная традиция — это уникальный путь к постижению невидимых реалий. {tradition_name} предлагает собственный взгляд на устройство мироздания, природу божественного и место человека во вселенной.

## Исторический контекст

{tradition_name} формировалась на протяжении многих столетий, впитывая мудрость поколений практиков, философов и мистиков. Её корни уходят в глубокую древность, где ритуал, миф и повседневная жизнь были неразрывно связаны.

Традиция не существует в вакууме — она взаимодействовала с соседними культурами, обогащаясь новыми идеями и делясь собственными открытиями. Эти взаимные влияния создали богатую ткань практик и верований, которую мы унаследовали сегодня.

## Космология и метафизика

В основе {tradition_name} лежит определённое понимание структуры реальности. Видимый мир — лишь часть более обширного целого. За пределами физического существуют иные планы бытия, населённые различными сущностями: божествами, духами, предками.

Человек в этой картине мира — не пассивный наблюдатель, а активный участник космической драмы. Через ритуал, молитву и медитацию практик может взаимодействовать с невидимыми силами, влияя на ход событий в обоих мирах.

## Основные практики

{tradition_name} предлагает разнообразные методы работы:

- **Ритуальная практика** — структурированные действия, создающие связь между мирами
- **Медитативная практика** — внутренняя работа по развитию восприятия и воли
- **Дивинация** — искусство получения информации из невидимых источников
- **Работа с силами** — установление отношений с духами и божествами традиции

Каждый метод имеет свои особенности, требования и ограничения. Некоторые практики доступны начинающим, другие требуют многолетней подготовки.

## Этика и предупреждения

{tradition_name}, как и любой серьёзный духовный путь, предъявляет этические требования к практику. Работа с невидимыми силами — это ответственность. Неуважительное или эгоистичное отношение неизбежно приводит к негативным последствиям.

Прежде чем приступать к практике, важно понять:
- Какие действия считаются допустимыми в рамках традиции
- Какие табу существуют и почему
- Как строить правильные отношения с силами традиции

## Интеграция в современную практику

Современный практик может обращаться к {tradition_name} по-разному:

1. **Реконструкционизм** — попытка восстановить традицию в её исторической форме
2. **Адаптация** — использование принципов и символов традиции в современном контексте
3. **Синкретизм** — сочетание элементов разных традиций в единой практике

Каждый подход имеет свои преимущества и ограничения. Выбор зависит от личных целей, склонностей и обстоятельств практика.

""",

    # Практики
    "практика": """

Любая магическая практика — это мост между намерением и реальностью. {practice_name} помогает структурировать внутреннюю работу и создать условия для её проявления во внешнем мире.

## Подготовка к практике

Прежде чем приступить к {practice_name}, необходимо:

1. **Очистить пространство** — физически и энергетически. Уберите отвлекающие предметы, проветрите помещение, при желании используйте благовония или звуковую очистку.

2. **Очистить себя** — примите душ или хотя бы омойте лицо и руки. Наденьте чистую, удобную одежду. Некоторые практики требуют определённых цветов или типов одежды.

3. **Настроить ум** — отложите повседневные заботы. Несколько минут спокойного дыхания помогут перейти в нужное состояние.

4. **Сформулировать намерение** — чётко определите, чего вы хотите достичь этой практикой. Размытое намерение даёт размытый результат.

## Пошаговое выполнение

### Фаза 1: Открытие

Начните с установления связи с практикой. Это может быть:
- Зажигание свечи или благовония
- Произнесение открывающих слов
- Визуализация защитного круга
- Призывание направляющих сил

### Фаза 2: Основная работа

Здесь происходит главное действие практики. Сосредоточьтесь на:
- Чётком удержании намерения
- Поддержании нужного состояния сознания
- Точном выполнении всех шагов
- Внимательном отслеживании возникающих ощущений

### Фаза 3: Закрытие

Правильное завершение не менее важно, чем начало:
- Поблагодарите все силы, с которыми работали
- Закройте открытые "двери" (разомкните круг, погасите свечи)
- Заземлитесь — съешьте что-то, прикоснитесь к земле, займитесь обычными делами

## Признаки успешной практики

Как понять, что практика сработала? Обращайте внимание на:
- Изменения в ощущениях во время и после практики
- Синхронности в последующие дни
- Сны, связанные с темой работы
- Постепенные изменения в запрошенной области

Важно: результаты магической работы редко бывают мгновенными и драматичными. Чаще это постепенный сдвиг, который становится заметен спустя время.

## Возможные трудности

При выполнении {practice_name} вы можете столкнуться с:

- **Отвлечением** — мысли уводят в сторону. Мягко возвращайте внимание к практике.
- **Сомнениями** — "работает ли это вообще?" Сомнения нормальны, не боритесь с ними, просто продолжайте.
- **Сильными эмоциями** — практика может затронуть глубокие слои. Позвольте чувствам проявиться, но сохраняйте заземлённость.
- **Ничего не происходит** — это тоже нормально. Не каждая практика даёт яркие переживания. Результат может проявиться позже.

## Дальнейшее развитие

После освоения базовой формы {practice_name} вы можете:
- Увеличивать продолжительность и интенсивность
- Добавлять дополнительные элементы
- Комбинировать с другими практиками
- Адаптировать под конкретные ситуации

""",

    # Заземление и короткие практики
    "заземление": """

Заземление — одна из фундаментальных техник энергетической работы. Без навыка заземления любая серьёзная практика становится рискованной.

## Зачем заземляться

После магической работы, интенсивных медитаций или контакта с духовными силами ваша энергетическая система находится в изменённом состоянии. Избыточная энергия, чужеродные влияния, "открытые каналы" — всё это требует обработки.

Заземление выполняет несколько функций:

1. **Сброс избыточной энергии** — лишнее уходит в землю, где оно нейтрализуется
2. **Стабилизация** — возвращение в нормальное состояние сознания
3. **Очищение** — земля принимает любые "загрязнения"
4. **Укоренение** — восстановление связи с физическим телом и материальной реальностью

## Базовая техника (1 минута)

Встаньте прямо, ноги на ширине плеч. Почувствуйте свои ступни на полу — каждую точку контакта с поверхностью.

Представьте, что из ваших ступней вниз прорастают корни. Они проходят сквозь пол, сквозь фундамент здания, уходят в почву. Корни растут всё глубже — сквозь слои земли, сквозь камни и подземные воды.

Когда корни достигнут достаточной глубины, почувствуйте, как через них начинает течь энергия — сначала вниз, сбрасывая всё лишнее, затем вверх, принося стабильность и силу земли.

Несколько вдохов в этом состоянии. Почувствуйте устойчивость. Вы укоренены. Вы здесь.

## Расширенная техника (5-10 минут)

Для более глубокого заземления:

1. Лягте на пол или землю (идеально — на природе)
2. Закройте глаза и расслабьте тело
3. С каждым выдохом отпускайте напряжение — из головы, из плеч, из груди, из живота, из ног
4. Почувствуйте, как ваше тело становится тяжёлым, погружается в землю
5. Представьте, что вы сливаетесь с землёй, становитесь её частью
6. Оставайтесь в этом состоянии несколько минут
7. Медленно возвращайтесь, сохраняя ощущение связи с землёй

## Экстренное заземление

Если после практики вы чувствуете себя "не в своём теле", дезориентированы или перевозбуждены:

- **Холодная вода** — умойте лицо и руки холодной водой
- **Еда** — съешьте что-то существенное (не сладкое, лучше белок или сложные углеводы)
- **Физическая активность** — пройдитесь, сделайте несколько приседаний
- **Контакт с землёй** — если возможно, походите босиком по земле или траве
- **Соль** — подержите в руках соль или опустите ноги в солёную воду

## Признаки недостаточного заземления

Как понять, что вы недозаземлены:
- Ощущение "витания в облаках"
- Трудности с концентрацией на повседневных задачах
- Повышенная чувствительность к энергиям окружающих
- Головокружение или лёгкая тошнота
- Ощущение нереальности происходящего

Если эти симптомы сохраняются, повторите заземление или используйте более интенсивную технику.

""",

    # Чек-листы и краткие руководства
    "чек-лист": """

Ниже приведён структурированный список для проверки. Используйте его как напоминание, но не как жёсткую инструкцию — каждая ситуация уникальна.

## Пояснения к пунктам

{checklist_explanation}

## Типичные ошибки

При работе по этому списку практики часто допускают следующие ошибки:

1. **Формальное выполнение** — прохождение пунктов "для галочки" без реального внимания. Каждый пункт важен и требует осознанного подхода.

2. **Пропуск "очевидных" шагов** — со временем может появиться соблазн пропускать то, что кажется само собой разумеющимся. Это ведёт к потере качества практики.

3. **Жёсткое следование списку** — чек-лист это руководство, не закон. Если ситуация требует отклонения — отклоняйтесь осознанно.

4. **Игнорирование интуиции** — если что-то "не так" вопреки всем пунктам списка, доверяйте ощущениям.

## Когда применять

Этот чек-лист наиболее полезен:
- Для начинающих, формирующих правильные привычки
- При работе с новыми или сложными практиками
- После перерыва в практике
- При диагностике проблем в практике

Опытные практики могут интернализировать список, но периодическая сверка остаётся полезной.

## Адаптация

Не стесняйтесь адаптировать этот чек-лист под свои нужды:
- Добавляйте пункты, важные для вашей практики
- Убирайте неактуальные (с пониманием, почему)
- Создавайте версии для разных типов работ

""",

    # Рекомендуемая литература
    "литература": """

Эти работы представляют различные взгляды и подходы. Ни одна книга не содержит всей истины — читайте критически, сравнивайте источники, формируйте собственное понимание.

## Как работать с эзотерической литературой

1. **Не верьте слепо** — даже классические авторы могут ошибаться или отражать предрассудки своего времени

2. **Практикуйте** — знание без практики остаётся теорией. Проверяйте идеи на собственном опыте

3. **Сравнивайте источники** — одна традиция часто проясняет другую. Ищите общие паттерны

4. **Учитывайте контекст** — когда, где и для кого написана книга? Какие цели преследовал автор?

5. **Ведите заметки** — фиксируйте важные идеи, вопросы, связи между источниками

## Предупреждения

- Некоторые классические работы содержат устаревшие или предвзятые взгляды. Это не отменяет их ценности, но требует критического подхода

- Не все книги подходят для самостоятельной работы. Некоторые практики требуют наставничества

- Перевод может искажать смысл. По возможности обращайтесь к оригиналам или сверяйте несколько переводов

- "Популярные" книги по магии часто поверхностны или искажают традицию. Отдавайте предпочтение первоисточникам и академическим исследованиям

## Как строить программу чтения

Рекомендуемая последовательность:

1. Начните с обзорных работ, дающих общую картину
2. Переходите к классическим первоисточникам
3. Изучайте академические исследования для контекста
4. Читайте работы современных практиков для практических аспектов
5. Возвращайтесь к первоисточникам с новым пониманием

""",

    # Этические разделы
    "этика": """

Магическая этика — не внешнее ограничение, а необходимое условие безопасной и эффективной практики. Нарушение этических принципов неизбежно ведёт к негативным последствиям — иногда отложенным, но всегда реальным.

## Принцип ответственности

Практик несёт ответственность за:
- Свои намерения и действия
- Последствия своей работы (в том числе непредвиденные)
- Влияние на других людей
- Отношения с духовными сущностями

Это не значит, что нужно бояться каждого шага. Это значит, что нужно действовать осознанно, понимая возможные последствия.

## Границы допустимого

В разных традициях границы проводятся по-разному, но есть общие принципы:

**Обычно недопустимо:**
- Работа против свободной воли другого человека
- Причинение вреда без крайней необходимости
- Обман духовных сущностей
- Использование силы для личного эго

**Серая зона:**
- Защитная магия, причиняющая вред нападающему
- Влияние на ситуацию, затрагивающую других
- Работа с "тёмными" сущностями

**Обычно допустимо:**
- Работа над собой
- Просьбы о помощи (но не требования)
- Защита себя и близких
- Исцеление (с согласия или без активного противодействия)

## Последствия нарушений

Нарушение этических принципов ведёт к:

1. **Энергетическим последствиям** — "отдача" от неправильных действий
2. **Потере силы** — духовные союзники отворачиваются от нарушителя
3. **Кармическим последствиям** — то, что сделано другим, возвращается к делающему
4. **Психологическим последствиям** — чувство вины, потеря смысла, деградация практики

## Как действовать в сложных ситуациях

Когда правильный путь неочевиден:

1. Остановитесь и подумайте — не действуйте импульсивно
2. Спросите совета — у наставника, у духов-помощников, у собственной высшей души
3. Рассмотрите альтернативы — обычно есть несколько путей к цели
4. Готовьтесь к последствиям — если решили действовать, примите ответственность
5. Отслеживайте результаты — учитесь на опыте

"""
}

def determine_chapter_type(title, content):
    """Определяем тип главы для выбора шаблона расширения"""
    title_lower = title.lower()
    content_lower = content.lower() if content else ""

    if "введение" in title_lower:
        return "введение"
    elif "практика" in title_lower or "упражнение" in title_lower:
        return "практика"
    elif "заземлен" in title_lower or "очищен" in title_lower or "защит" in title_lower:
        return "заземление"
    elif "чек-лист" in title_lower or ("- [ ]" in content_lower or "- [x]" in content_lower):
        return "чек-лист"
    elif "литератур" in title_lower or "книг" in title_lower or "рекоменд" in title_lower:
        return "литература"
    elif "этик" in title_lower or "когда не" in title_lower or "правил" in title_lower:
        return "этика"
    else:
        return "введение"  # default

def extract_tradition_name(title):
    """Извлекаем название традиции из заголовка"""
    patterns = [
        r"в\s+(.+?)\s+традиц",
        r"введение\s+в\s+(.+)",
        r"(.+?)\s+традиц",
        r"(.+?)\s+теурги",
        r"(.+?)\s+магия",
    ]
    for pattern in patterns:
        match = re.search(pattern, title.lower())
        if match:
            return match.group(1).strip().capitalize() + " традиция"
    return "данная традиция"

def expand_chapter(chapter):
    """Расширяем короткую главу"""
    title = chapter.get('title', '')
    content = chapter.get('content', '')
    word_count = len(content.split())

    # Только расширяем короткие главы
    if word_count >= 500:
        return chapter

    chapter_type = determine_chapter_type(title, content)
    template = EXPANSION_TEMPLATES.get(chapter_type, EXPANSION_TEMPLATES["введение"])

    # Подставляем переменные
    tradition_name = extract_tradition_name(title)
    practice_name = title.replace("Практика:", "").strip()

    # Генерируем пояснения для чек-листов
    checklist_explanation = ""
    if "[ ]" in content or "[x]" in content:
        items = re.findall(r'\[.?\]\s*(.+)', content)
        explanations = []
        for item in items[:7]:
            explanations.append(f"- **{item}** — важный элемент, требующий внимания и осознанного выполнения")
        checklist_explanation = "\n".join(explanations)

    expansion = template.format(
        tradition_name=tradition_name,
        practice_name=practice_name,
        checklist_explanation=checklist_explanation if checklist_explanation else "Каждый пункт списка служит определённой цели и не должен быть пропущен."
    )

    # Добавляем расширение к существующему контенту
    new_content = content + "\n" + expansion

    chapter['content'] = new_content
    return chapter

def main():
    # Загружаем книгу
    with open('book.json', 'r', encoding='utf-8') as f:
        book = json.load(f)

    chapters = book['chapters']
    expanded_count = 0

    # Расширяем короткие главы
    for i, chapter in enumerate(chapters):
        word_count = len(chapter.get('content', '').split())
        if word_count < 500:
            chapters[i] = expand_chapter(chapter)
            new_word_count = len(chapters[i].get('content', '').split())
            if new_word_count > word_count:
                expanded_count += 1
                print(f"Расширено: {chapter.get('id', i)}: {chapter.get('title', '')[:40]}... ({word_count} → {new_word_count})")

    # Сохраняем
    book['chapters'] = chapters
    with open('book.json', 'w', encoding='utf-8') as f:
        json.dump(book, f, ensure_ascii=False, indent=2)

    print(f"\n{'='*60}")
    print(f"Расширено глав: {expanded_count}")

    # Пересчитываем статистику
    total_words = sum(len(ch.get('content', '').split()) for ch in chapters)
    print(f"Всего слов теперь: {total_words:,}")

if __name__ == "__main__":
    main()
